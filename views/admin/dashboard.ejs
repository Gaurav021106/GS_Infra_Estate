<%- include('../components/header') %>

<nav class="m-0 w-full h-[8vh] fixed top-0 left-0 right-0 z-50
     bg-white/80 backdrop-blur flex items-center justify-between px-4 border-b border-gray-100">
  <!-- Brand -->
  <div class="flex items-center">
    <a href="/admin/dashboard" class="flex items-center nav-link">
      <img src="/images/logo.jpg" alt="Logo" class="w-10 h-10 md:w-12 md:h-12 mr-3 rounded-xl" />
      <h1 class="font-semibold text-lg md:text-xl">GS Infra Estate Admin</h1>
    </a>
  </div>

  <!-- Right actions -->
  <div class="flex items-center space-x-2">
    <a href="../"
       class="mx-1 px-4 py-1 rounded-full text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors nav-link text-sm md:text-base">
       Home
    </a>
    <a href="/admin/logout"
       class="mx-1 px-4 py-1 rounded-full text-white bg-red-600 hover:bg-red-700 transition-colors nav-link text-sm md:text-base">
       Logout
    </a>
  </div>
</nav>

<div class="min-h-screen bg-gray-50 px-4 md:px-6 lg:px-10 py-6 pt-24">
  <h1 class="text-2xl md:text-3xl font-bold mb-6">
    <%= editingProperty ? `Edit: ${editingProperty.title}` : 'Admin Dashboard' %>
  </h1>

  <!-- Toast Notifications -->
  <div id="toast"
       class="fixed top-20 right-4 z-50 hidden px-4 py-2 rounded-lg shadow-lg text-sm font-medium text-white bg-gray-800/90">
  </div>

  <!-- Add/Edit Property Form -->
  <section class="bg-white rounded-xl shadow p-5 md:p-6 mb-10 border border-gray-100">
    <h2 class="text-lg md:text-xl font-semibold mb-4">
      <%= editingProperty ? 'Edit Property' : 'Add New Property' %>
    </h2>
    
    <form 
      id="propertyForm"
      action="<%= editingProperty ? `/admin/properties/${editingProperty._id}/update` : '/admin/properties/new' %>" 
      method="POST" 
      enctype="multipart/form-data"
      class="grid md:grid-cols-2 gap-4 md:gap-5"
    >
      <!-- Category/Type -->
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select name="category" class="border rounded-lg px-3 py-2 w-full text-sm md:text-base" required>
          <option value="residential_properties" <%= editingProperty?.category === 'residential_properties' ? 'selected' : '' %>>Residential Properties</option>
          <option value="commercial_plots" <%= editingProperty?.category === 'commercial_plots' ? 'selected' : '' %>>Commercial Plots</option>
          <option value="land_plots" <%= editingProperty?.category === 'land_plots' ? 'selected' : '' %>>Land & Plots</option>
          <option value="premium_investment" <%= editingProperty?.category === 'premium_investment' ? 'selected' : '' %>>Premium & Investment</option>
        </select>
      </div>

      <!-- Title -->
      <div>
        <label class="block text-sm font-medium mb-1">Title</label>
        <input 
          name="title" 
          value="<%= editingProperty?.title || '' %>" 
          class="border rounded-lg px-3 py-2 w-full text-sm md:text-base" 
          required
        >
      </div>

      <!-- Price -->
      <div>
        <label class="block text-sm font-medium mb-1">Price (INR)</label>
        <input 
          type="number" 
          name="price" 
          value="<%= editingProperty?.price || '' %>" 
          class="border rounded-lg px-3 py-2 w-full text-sm md:text-base" 
          required
        >
      </div>

      <!-- Location -->
      <div>
        <label class="block text-sm font-medium mb-1">Location</label>
        <input 
          name="location" 
          value="<%= editingProperty?.location || '' %>" 
          class="border rounded-lg px-3 py-2 w-full text-sm md:text-base"
          placeholder="Rishikesh, Uttarakhand" 
          required
        >
      </div>

      <!-- City and State (extracted from location) -->
      <input type="hidden" name="city" id="cityInput" />
      <input type="hidden" name="state" id="stateInput" />

      <!-- Suitable For -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Suitable For</label>
        <input 
          name="suitableFor" 
          value="<%= editingProperty?.suitableFor?.join(', ') || '' %>" 
          class="border rounded-lg px-3 py-2 w-full text-sm md:text-base"
          placeholder="Family, Investment, Farmhouse"
        >
      </div>

      <!-- Current Files Preview (Edit mode only) -->
      <% if (editingProperty) { %>
        <% if (editingProperty.map3dUrl) { %>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Current 3D Map:</label>
            <img src="<%= editingProperty.map3dUrl %>" class="w-32 h-32 object-cover rounded-lg border" />
          </div>
        <% } %>
        
        <% if (editingProperty.virtualTourUrl) { %>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Current Virtual Tour:</label>
            <video src="<%= editingProperty.virtualTourUrl %>" class="w-32 h-32 object-cover rounded-lg border" controls></video>
          </div>
        <% } %>

        <% if (editingProperty.imageUrls?.length) { %>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Current Images:</label>
            <div class="grid grid-cols-4 md:grid-cols-6 gap-2 mt-2">
              <% editingProperty.imageUrls.forEach(img => { %>
                <img src="<%= img %>" class="w-20 h-20 object-cover rounded border" />
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (editingProperty.videoUrls?.length) { %>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Current Videos:</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
              <% editingProperty.videoUrls.slice(0,4).forEach(video => { %>
                <video src="<%= video %>" class="w-20 h-20 object-cover rounded border" controls></video>
              <% }) %>
            </div>
          </div>
        <% } %>
      <% } %>

      <!-- New File Uploads -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">3D Map / 360 Image (one file)</label>
        <input type="file" name="map3dFile" accept="image/*,.glb,.gltf,.obj,.fbx"
               class="border rounded-lg px-3 py-2 w-full text-sm md:text-base">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Virtual Tour Video (one file)</label>
        <input type="file" name="virtualTourFile" accept="video/*"
               class="border rounded-lg px-3 py-2 w-full text-sm md:text-base">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">
          Property Images (max 10) - <%= editingProperty?.imageUrls?.length || 0 %> existing
        </label>
        <input type="file" name="images" multiple accept="image/*"
               class="border rounded-lg px-3 py-2 w-full text-sm md:text-base">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">
          Property Videos (max 10) - <%= editingProperty?.videoUrls?.length || 0 %> existing
        </label>
        <input type="file" name="videos" multiple accept="video/*"
               class="border rounded-lg px-3 py-2 w-full text-sm md:text-base">
      </div>

      <!-- Description -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Description</label>
        <textarea 
          name="description" 
          rows="3"
          class="border rounded-lg px-3 py-2 w-full text-sm md:text-base"
        ><%= editingProperty?.description || '' %></textarea>
      </div>

      <div class="md:col-span-2 flex justify-end space-x-3">
        <% if (editingProperty) { %>
          <a href="/admin/dashboard" 
             class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold transition">
            Cancel
          </a>
        <% } %>
        <button type="submit"
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 text-sm md:text-base font-semibold shadow-sm transition">
          <%= editingProperty ? 'Update Property' : 'Add Property' %>
        </button>
      </div>
    </form>
  </section>

  <!-- Property Lists (only show when not editing) -->
  <% if (!editingProperty) { %>
    <section class="space-y-8">
      <!-- Residential Properties -->
      <div>
        <h2 class="text-lg md:text-xl font-semibold mb-2">Residential Properties</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
          <table class="w-full text-xs md:text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-2">Image</th>
                <th class="border px-2 py-2">Title</th>
                <th class="border px-2 py-2">Location</th>
                <th class="border px-2 py-2">Price</th>
                <th class="border px-2 py-2">Suitable For</th>
                <th class="border px-2 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% residential.forEach(p => { %>
                <tr class="even:bg-gray-50 hover:bg-gray-50" data-id="<%= p._id %>" data-category="<%= p.category %>">
                  <td class="border px-2 py-1 text-center">
                    <% if (p.imageUrls && p.imageUrls.length) { %>
                      <img src="<%= p.imageUrls[0] %>" alt="front image"
                           class="w-20 h-16 object-cover rounded mx-auto border" />
                    <% } else { %>
                      <span class="text-xs text-gray-400">No image</span>
                    <% } %>
                  </td>
                  <td class="border px-2 py-1 font-medium"><%= p.title %></td>
                  <td class="border px-2 py-1"><%= p.location %></td>
                  <td class="border px-2 py-1">₹ <%= p.price.toLocaleString('en-IN') %></td>
                  <td class="border px-2 py-1">
                    <%= (p.suitableFor || []).join(', ').substring(0,20) +
                        ((p.suitableFor || []).join(', ').length > 20 ? '...' : '') %>
                  </td>
                  <td class="border px-2 py-1 space-x-2 whitespace-nowrap">
                    <button type="button"
                            class="js-edit inline-block px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 transition">
                      Edit
                    </button>
                    <button type="button"
                            class="js-delete px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition">
                      Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
              <% if (!residential.length) { %>
                <tr>
                  <td colspan="6" class="border px-2 py-8 text-center text-gray-500">
                    <div class="py-8">
                      <p class="text-lg font-medium mb-2">No residential properties yet</p>
                      <p class="text-sm">Add your first residential property above</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Commercial Plots -->
      <div>
        <h2 class="text-lg md:text-xl font-semibold mb-2">Commercial Plots</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
          <table class="w-full text-xs md:text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-2">Image</th>
                <th class="border px-2 py-2">Title</th>
                <th class="border px-2 py-2">Location</th>
                <th class="border px-2 py-2">Price</th>
                <th class="border px-2 py-2">Suitable For</th>
                <th class="border px-2 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% commercialPlots.forEach(p => { %>
                <tr class="even:bg-gray-50 hover:bg-gray-50" data-id="<%= p._id %>" data-category="<%= p.category %>">
                  <td class="border px-2 py-1 text-center">
                    <% if (p.imageUrls && p.imageUrls.length) { %>
                      <img src="<%= p.imageUrls[0] %>" alt="front image"
                           class="w-20 h-16 object-cover rounded mx-auto border" />
                    <% } else { %>
                      <span class="text-xs text-gray-400">No image</span>
                    <% } %>
                  </td>
                  <td class="border px-2 py-1 font-medium"><%= p.title %></td>
                  <td class="border px-2 py-1"><%= p.location %></td>
                  <td class="border px-2 py-1">₹ <%= p.price.toLocaleString('en-IN') %></td>
                  <td class="border px-2 py-1">
                    <%= (p.suitableFor || []).join(', ').substring(0,20) +
                        ((p.suitableFor || []).join(', ').length > 20 ? '...' : '') %>
                  </td>
                  <td class="border px-2 py-1 space-x-2 whitespace-nowrap">
                    <button type="button"
                            class="js-edit inline-block px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 transition">
                      Edit
                    </button>
                    <button type="button"
                            class="js-delete px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition">
                      Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
              <% if (!commercialPlots.length) { %>
                <tr>
                  <td colspan="6" class="border px-2 py-8 text-center text-gray-500">
                    <div class="py-8">
                      <p class="text-lg font-medium mb-2">No commercial plots yet</p>
                      <p class="text-sm">Add your first commercial property above</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Land & Plots -->
      <div>
        <h2 class="text-lg md:text-xl font-semibold mb-2">Land & Plots</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
          <table class="w-full text-xs md:text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-2">Image</th>
                <th class="border px-2 py-2">Title</th>
                <th class="border px-2 py-2">Location</th>
                <th class="border px-2 py-2">Price</th>
                <th class="border px-2 py-2">Suitable For</th>
                <th class="border px-2 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% landPlots.forEach(p => { %>
                <tr class="even:bg-gray-50 hover:bg-gray-50" data-id="<%= p._id %>" data-category="<%= p.category %>">
                  <td class="border px-2 py-1 text-center">
                    <% if (p.imageUrls && p.imageUrls.length) { %>
                      <img src="<%= p.imageUrls[0] %>" alt="front image"
                           class="w-20 h-16 object-cover rounded mx-auto border" />
                    <% } else { %>
                      <span class="text-xs text-gray-400">No image</span>
                    <% } %>
                  </td>
                  <td class="border px-2 py-1 font-medium"><%= p.title %></td>
                  <td class="border px-2 py-1"><%= p.location %></td>
                  <td class="border px-2 py-1">₹ <%= p.price.toLocaleString('en-IN') %></td>
                  <td class="border px-2 py-1">
                    <%= (p.suitableFor || []).join(', ').substring(0,20) +
                        ((p.suitableFor || []).join(', ').length > 20 ? '...' : '') %>
                  </td>
                  <td class="border px-2 py-1 space-x-2 whitespace-nowrap">
                    <button type="button"
                            class="js-edit inline-block px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 transition">
                      Edit
                    </button>
                    <button type="button"
                            class="js-delete px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition">
                      Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
              <% if (!landPlots.length) { %>
                <tr>
                  <td colspan="6" class="border px-2 py-8 text-center text-gray-500">
                    <div class="py-8">
                      <p class="text-lg font-medium mb-2">No land or plots yet</p>
                      <p class="text-sm">Add your first land / plot above</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Premium & Investment -->
      <div>
        <h2 class="text-lg md:text-xl font-semibold mb-2">Premium & Investment</h2>
        <div class="overflow-x-auto bg-white rounded-xl shadow border border-gray-200">
          <table class="w-full text-xs md:text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="border px-2 py-2">Image</th>
                <th class="border px-2 py-2">Title</th>
                <th class="border px-2 py-2">Location</th>
                <th class="border px-2 py-2">Price</th>
                <th class="border px-2 py-2">Suitable For</th>
                <th class="border px-2 py-2">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% premiumInvestment.forEach(p => { %>
                <tr class="even:bg-gray-50 hover:bg-gray-50" data-id="<%= p._id %>" data-category="<%= p.category %>">
                  <td class="border px-2 py-1 text-center">
                    <% if (p.imageUrls && p.imageUrls.length) { %>
                      <img src="<%= p.imageUrls[0] %>" alt="front image"
                           class="w-20 h-16 object-cover rounded mx-auto border" />
                    <% } else { %>
                      <span class="text-xs text-gray-400">No image</span>
                    <% } %>
                  </td>
                  <td class="border px-2 py-1 font-medium"><%= p.title %></td>
                  <td class="border px-2 py-1"><%= p.location %></td>
                  <td class="border px-2 py-1">₹ <%= p.price.toLocaleString('en-IN') %></td>
                  <td class="border px-2 py-1">
                    <%= (p.suitableFor || []).join(', ').substring(0,20) +
                        ((p.suitableFor || []).join(', ').length > 20 ? '...' : '') %>
                  </td>
                  <td class="border px-2 py-1 space-x-2 whitespace-nowrap">
                    <button type="button"
                            class="js-edit inline-block px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 transition">
                      Edit
                    </button>
                    <button type="button"
                            class="js-delete px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition">
                      Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
              <% if (!premiumInvestment.length) { %>
                <tr>
                  <td colspan="6" class="border px-2 py-8 text-center text-gray-500">
                    <div class="py-8">
                      <p class="text-lg font-medium mb-2">No premium / investment properties yet</p>
                      <p class="text-sm">Add your first premium property above</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  <% } %>
</div>

<script>
(function () {
  const form = document.getElementById('propertyForm');
  if (!form) return;

  let mode = 'create';
  let editingId = null;

  const submitBtn = form.querySelector('button[type="submit"]');
  const locationInput = form.querySelector('input[name="location"]');
  const cityInput = form.querySelector('input[name="city"]');
  const stateInput = form.querySelector('input[name="state"]');
  const toastEl = document.getElementById('toast');

  const tables = document.querySelectorAll('section.space-y-8 table');
  const residentialTbody    = tables[0]?.querySelector('tbody');
  const commercialTbody     = tables[1]?.querySelector('tbody');
  const landTbody           = tables[2]?.querySelector('tbody');
  const premiumTbody        = tables[3]?.querySelector('tbody');

  const getBodyByCategory = (cat) => {
    if (cat === 'residential_properties') return residentialTbody;
    if (cat === 'commercial_plots')       return commercialTbody;
    if (cat === 'land_plots')            return landTbody;
    if (cat === 'premium_investment')    return premiumTbody;
    return residentialTbody;
  };

  function showToast(message, type = 'success') {
    if (!toastEl) return;
    toastEl.textContent = message;
    toastEl.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
    toastEl.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
    setTimeout(() => {
      toastEl.classList.add('hidden');
    }, 2500);
  }

  function fillCityState() {
    if (!locationInput || !cityInput || !stateInput) return;
    if (locationInput.value) {
      const parts = locationInput.value.split(',').map(p => p.trim());
      if (parts.length >= 1) cityInput.value = parts[0];
      if (parts.length >= 2) stateInput.value = parts[1];
    }
  }

  function createRow(p) {
    const tr = document.createElement('tr');
    tr.className = 'even:bg-gray-50 hover:bg-gray-50';
    tr.dataset.id = p._id;
    tr.dataset.category = p.category;

    const firstImage = (p.imageUrls && p.imageUrls.length) ? p.imageUrls[0] : null;
    const suitableStr = (p.suitableFor || []).join(', ');
    const suitableShort = suitableStr.substring(0, 20) + (suitableStr.length > 20 ? '...' : '');

    tr.innerHTML = `
      <td class="border px-2 py-1 text-center">
        ${firstImage
          ? `<img src="${firstImage}" alt="front image"
                 class="w-20 h-16 object-cover rounded mx-auto border" />`
          : `<span class="text-xs text-gray-400">No image</span>`}
      </td>
      <td class="border px-2 py-1 font-medium">${p.title}</td>
      <td class="border px-2 py-1">${p.location}</td>
      <td class="border px-2 py-1">₹ ${Number(p.price).toLocaleString('en-IN')}</td>
      <td class="border px-2 py-1">${suitableShort}</td>
      <td class="border px-2 py-1 space-x-2 whitespace-nowrap">
        <button type="button"
                class="js-edit inline-block px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 transition">
          Edit
        </button>
        <button type="button"
                class="js-delete px-3 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700 transition">
          Delete
        </button>
      </td>
    `;
    return tr;
  }

  function resetForm() {
    form.reset();
    mode = 'create';
    editingId = null;
    if (submitBtn) {
      submitBtn.textContent = 'Add Property';
      submitBtn.disabled = false;
    }
  }

  function populateFormFromRow(p) {
    form.querySelector('select[name="category"]').value = p.category || 'residential_properties';
    form.querySelector('input[name="title"]').value = p.title || '';
    form.querySelector('input[name="price"]').value = p.price || '';
    form.querySelector('input[name="location"]').value = p.location || '';
    form.querySelector('input[name="suitableFor"]').value = (p.suitableFor || []).join(', ');
    form.querySelector('textarea[name="description"]').value = p.description || '';
    if (locationInput) {
      fillCityState();
    }
  }

  function readPropertyFromRow(tr) {
    const tds = tr.querySelectorAll('td');
    const title = tds[1]?.textContent.trim();
    const location = tds[2]?.textContent.trim();
    const priceText = (tds[3]?.textContent || '').replace(/[₹ ,]/g, '');
    const suitableFor = (tds[4]?.textContent || '').replace('...', '').split(',')
      .map(s => s.trim())
      .filter(Boolean);

    return {
      _id: tr.dataset.id,
      category: tr.dataset.category,
      title,
      location,
      price: priceText || '',
      suitableFor,
      description: ''
    };
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!submitBtn) return;

    fillCityState();

    submitBtn.disabled = true;
    submitBtn.textContent = mode === 'edit' ? 'Updating...' : 'Saving...';

    const formData = new FormData(form);
    const url = mode === 'edit'
      ? `/admin/properties/${editingId}/update`
      : '/admin/properties/new';

    try {
      const res = await fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          Accept: 'application/json'
        }
      });

      const data = await res.json().catch(() => null);

      if (!res.ok || !data || data.ok === false || data.error) {
        throw new Error((data && data.error) || 'Save failed');
      }

      const p = data.property || data;

      const body = getBodyByCategory(p.category);
      if (!body) {
        showToast('Saved but table not found', 'error');
      } else if (mode === 'create') {
        if (body.children.length === 1 && body.children[0].querySelector('p')) {
          body.innerHTML = '';
        }
        body.prepend(createRow(p));
      } else {
        const existingRow = body.querySelector(`tr[data-id="${editingId}"]`);
        if (existingRow) {
          const newTr = createRow(p);
          body.replaceChild(newTr, existingRow);
        } else {
          body.prepend(createRow(p));
        }
      }

      showToast(mode === 'edit' ? 'Property updated' : 'Property created', 'success');
      resetForm();
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Save failed', 'error');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = mode === 'edit' ? 'Update Property' : 'Add Property';
      }
    }
  });

  document.addEventListener('click', async function (e) {
    const editBtn = e.target.closest('.js-edit');
    const deleteBtn = e.target.closest('.js-delete');

    if (editBtn) {
      const tr = editBtn.closest('tr');
      if (!tr) return;

      const p = readPropertyFromRow(tr);
      populateFormFromRow(p);
      mode = 'edit';
      editingId = p._id;

      if (submitBtn) {
        submitBtn.textContent = 'Update Property';
        submitBtn.disabled = false;
      }

      window.scrollTo({
        top: form.getBoundingClientRect().top + window.scrollY - 100,
        behavior: 'smooth'
      });
    }

    if (deleteBtn) {
      const tr = deleteBtn.closest('tr');
      if (!tr) return;
      const id = tr.dataset.id;
      const cat = tr.dataset.category;

      if (!confirm('Delete this property? Are you sure?')) return;

      try {
        const res = await fetch(`/admin/properties/${id}/delete`, {
          method: 'POST',
          headers: { Accept: 'application/json' }
        });
        const data = await res.json().catch(() => null);
        if (!res.ok || (data && data.ok === false)) {
          throw new Error((data && data.error) || 'Delete failed');
        }

        tr.remove();
        showToast('Property deleted', 'success');

        const body = getBodyByCategory(cat);
        if (body && !body.children.length) {
          body.innerHTML = `
            <tr>
              <td colspan="6" class="border px-2 py-8 text-center text-gray-500">
                <div class="py-8">
                  <p class="text-lg font-medium mb-2">No properties yet</p>
                  <p class="text-sm">Add your first property above</p>
                </div>
              </td>
            </tr>
          `;
        }
      } catch (err) {
        console.error(err);
        showToast(err.message || 'Delete failed', 'error');
      }
    }
  });
})();
</script>

<%- include('../components/footer') %>
