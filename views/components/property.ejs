<%- include('../components/header') %>


<% const hasAnyProperty =
  (flats && flats.length > 0) ||
  (plots && plots.length > 0) ||
  (agri && agri.length > 0); %>


<% if (hasAnyProperty) { %>
<section
  class="flex flex-col items-center justify-center mt-4 p-6 bg-gray-50 rounded-xl shadow-sm w-full animate-fadeInUp animation-delay-200"
>
  <!-- Filter + Heading same section -->
  <div class="w-full mb-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="mb-1 text-3xl font-bold animate-slideInDown">Available Properties</h1>
        <p class="text-sm text-gray-500">
          Filter properties by location and budget across Uttarakhand.
        </p>
        <p id="resultsCount" class="mt-1 text-xs text-gray-600 font-medium hidden">
          Showing <span id="countNum">0</span> properties
        </p>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full md:w-auto">
        <!-- Location Filter -->
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Location</label>
          <select
            id="locationFilter"
            class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C] text-xs md:text-sm transition-all duration-200"
          >
            <option value="">All Locations</option>
          </select>
        </div>

        <!-- Price Range Filter -->
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Price Range</label>
          <select
            id="priceFilter"
            class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C] text-xs md:text-sm transition-all duration-200"
          >
            <option value="">All Prices</option>
            <option value="100000-500000">₹1L - ₹5L</option>
            <option value="500000-10000000">₹5L - ₹1Cr</option>
            <option value="10000000+">₹1Cr+</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="flex items-end">
          <button
            id="clearFilters"
            type="button"
            class="w-full px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs md:text-sm font-semibold rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-0.5"
          >
            Clear Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Email Alerts Button -->
    <div class="mt-3">
      <button
        id="emailAlertBtn"
        type="button"
        class="px-4 py-2.5 bg-[#A1824C] hover:bg-[#8b6f3f]
               text-white text-xs md:text-sm font-semibold rounded-lg
               shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-0.5"
      >
        Enable Email Alerts
      </button>
      <p class="mt-1 text-[11px] text-gray-500">
        Get an email whenever a new property is listed in any location.
      </p>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div
    id="loadingSpinner"
    class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 hidden items-center justify-center"
  >
    <div class="bg-white p-6 rounded-2xl shadow-2xl animate-pulse">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#A1824C] mx-auto mb-3"></div>
      <p class="text-sm md:text-lg font-semibold text-gray-800">Filtering properties...</p>
    </div>
  </div>

  <!-- Flats & Houses -->
  <% if (flats && flats.length > 0) { %>
    <div class="w-full mb-6" data-section="flats">
      <h2 class="text-xl font-semibold mb-3">Flats &amp; Houses in Uttarakhand</h2>
      <div class="grid md:grid-cols-3 gap-4" id="flatsContainer">
        <% flats.forEach(function(p){ %>
          <div
            class="property-card group bg-white rounded-xl shadow-md p-3 flex flex-col cursor-pointer
                   border border-gray-100 transform transition-all duration-200 ease-out
                   hover:-translate-y-1 hover:shadow-xl hover:border-indigo-200 animate-fadeInUp"
            data-id="<%= p._id %>"
            data-location="<%= p.location %>"
            data-price="<%= p.price %>"
            data-type="flat"
          >
            <% if (p.imageUrls && p.imageUrls.length) { %>
              <div class="relative overflow-hidden rounded-lg mb-3">
                <img
                  src="<%= p.imageUrls[0] %>"
                  alt="front image"
                  loading="lazy"
                  class="w-full h-40 object-cover rounded-lg transition-transform duration-300 ease-out group-hover:scale-105"
                />
                <div
                  class="pointer-events-none absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"
                ></div>
              </div>
            <% } else { %>
              <div
                class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500"
              >
                No image
              </div>
            <% } %>

            <h3 class="font-semibold text-lg mb-1 line-clamp-1"><%= p.title %></h3>
            <p class="text-sm text-gray-600 mb-1 line-clamp-1"><%= p.location %></p>
            <p class="text-sm font-semibold text-[#A1824C] mb-1">
              ₹ <%= p.price.toLocaleString('en-IN') %>
            </p>
            <p class="text-xs text-gray-500 mb-2 line-clamp-2">
              Suitable for: <%= (p.suitableFor || []).join(', ') || ' N/A' %>
            </p>

            <div class="mt-2 flex flex-wrap gap-2">
              <a
                href="https://wa.me/918279702969?text=<%= encodeURIComponent('I am interested in ' + p.title + ' at ' + p.location) %>"
                target="_blank"
                rel="noopener"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-emerald-600 text-white hover:bg-emerald-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                WhatsApp Enquiry
              </a>
              <a
                href="tel:+918279702969"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-blue-600 text-white hover:bg-blue-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                Call Now
              </a>
              <!-- Share Button -->
              <button
                type="button"
                class="share-btn px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-gray-800 text-white hover:bg-gray-900
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
                data-title="<%= p.title %>"
                data-location="<%= p.location %>"
                data-price="<%= p.price %>"
              >
                Share
              </button>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  <% } %>

  <!-- Plots -->
  <% if (plots && plots.length > 0) { %>
    <div class="w-full mb-6" data-section="plots">
      <h2 class="text-xl font-semibold mb-3">Plots in Uttarakhand</h2>
      <div class="grid md:grid-cols-3 gap-4" id="plotsContainer">
        <% plots.forEach(function(p){ %>
          <div
            class="property-card group bg-white rounded-xl shadow-md p-3 flex flex-col cursor-pointer
                   border border-gray-100 transform transition-all duration-200 ease-out
                   hover:-translate-y-1 hover:shadow-xl hover:border-indigo-200 animate-fadeInUp"
            data-id="<%= p._id %>"
            data-location="<%= p.location %>"
            data-price="<%= p.price %>"
            data-type="plot"
          >
            <% if (p.imageUrls && p.imageUrls.length) { %>
              <div class="relative overflow-hidden rounded-lg mb-3">
                <img
                  src="<%= p.imageUrls[0] %>"
                  alt="front image"
                  loading="lazy"
                  class="w-full h-40 object-cover rounded-lg transition-transform duration-300 ease-out group-hover:scale-105"
                />
                <div
                  class="pointer-events-none absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"
                ></div>
              </div>
            <% } else { %>
              <div
                class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500"
              >
                No image
              </div>
            <% } %>

            <h3 class="font-semibold text-lg mb-1 line-clamp-1"><%= p.title %></h3>
            <p class="text-sm text-gray-600 mb-1 line-clamp-1"><%= p.location %></p>
            <p class="text-sm font-semibold text-[#A1824C] mb-1">
              ₹ <%= p.price.toLocaleString('en-IN') %>
            </p>
            <p class="text-xs text-gray-500 mb-2 line-clamp-2">
              Suitable for: <%= (p.suitableFor || []).join(', ') || ' N/A' %>
            </p>

            <div class="mt-2 flex flex-wrap gap-2">
              <a
                href="https://wa.me/918279702969?text=<%= encodeURIComponent('I am interested in ' + p.title + ' at ' + p.location) %>"
                target="_blank"
                rel="noopener"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-emerald-600 text-white hover:bg-emerald-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                WhatsApp Enquiry
              </a>
              <a
                href="tel:+918279702969"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-blue-600 text-white hover:bg-blue-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                Call Now
              </a>
              <!-- Share Button -->
              <button
                type="button"
                class="share-btn px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-gray-800 text-white hover:bg-gray-900
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
                data-title="<%= p.title %>"
                data-location="<%= p.location %>"
                data-price="<%= p.price %>"
              >
                Share
              </button>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  <% } %>

  <!-- Agricultural Land -->
  <% if (agri && agri.length > 0) { %>
    <div class="w-full" data-section="agri">
      <h2 class="text-xl font-semibold mb-3">Agricultural Land in Uttarakhand</h2>
      <div class="grid md:grid-cols-3 gap-4" id="agriContainer">
        <% agri.forEach(function(p){ %>
          <div
            class="property-card group bg-white rounded-xl shadow-md p-3 flex flex-col cursor-pointer
                   border border-gray-100 transform transition-all duration-200 ease-out
                   hover:-translate-y-1 hover:shadow-xl hover:border-indigo-200 animate-fadeInUp"
            data-id="<%= p._id %>"
            data-location="<%= p.location %>"
            data-price="<%= p.price %>"
            data-type="agri"
          >
            <% if (p.imageUrls && p.imageUrls.length) { %>
              <div class="relative overflow-hidden rounded-lg mb-3">
                <img
                  src="<%= p.imageUrls[0] %>"
                  alt="front image"
                  loading="lazy"
                  class="w-full h-40 object-cover rounded-lg transition-transform duration-300 ease-out group-hover:scale-105"
                />
                <div
                  class="pointer-events-none absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300"
                ></div>
              </div>
            <% } else { %>
              <div
                class="w-full h-40 bg-gray-200 rounded-lg flex items-center justify-center text-xs text-gray-500"
              >
                No image
              </div>
            <% } %>

            <h3 class="font-semibold text-lg mb-1 line-clamp-1"><%= p.title %></h3>
            <p class="text-sm text-gray-600 mb-1 line-clamp-1"><%= p.location %></p>
            <p class="text-sm font-semibold text-[#A1824C] mb-1">
              ₹ <%= p.price.toLocaleString('en-IN') %>
            </p>
            <p class="text-xs text-gray-500 mb-2 line-clamp-2">
              Suitable for: <%= (p.suitableFor || []).join(', ') || ' N/A' %>
            </p>

            <div class="mt-2 flex flex-wrap gap-2">
              <a
                href="https://wa.me/918279702969?text=<%= encodeURIComponent('I am interested in ' + p.title + ' at ' + p.location) %>"
                target="_blank"
                rel="noopener"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-emerald-600 text-white hover:bg-emerald-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                WhatsApp Enquiry
              </a>
              <a
                href="tel:+918279702969"
                class="px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-blue-600 text-white hover:bg-blue-700
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
              >
                Call Now
              </a>
              <!-- Share Button -->
              <button
                type="button"
                class="share-btn px-3 py-1.5 rounded-lg text-xs md:text-sm font-semibold
                       bg-gray-800 text-white hover:bg-gray-900
                       shadow-sm hover:shadow-md transition-transform duration-200 hover:-translate-y-0.5"
                data-title="<%= p.title %>"
                data-location="<%= p.location %>"
                data-price="<%= p.price %>"
              >
                Share
              </button>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  <% } %>
</section>

<!-- Email Alert Modal -->
<div id="emailAlertModal"
     class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center">
  <div class="bg-white rounded-xl p-5 w-80 shadow-2xl">
    <h3 class="text-lg font-semibold mb-2">Get New Property Alerts</h3>
    <p class="text-xs text-gray-500 mb-3">
      Get an email whenever a new property is listed in any location.
    </p>
    <input
      type="email"
      id="emailAlertInput"
      placeholder="Enter your email"
      class="w-full mb-3 px-3 py-2 border border-gray-200 rounded-lg
             text-sm focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C]"
    />
    <div class="flex justify-end gap-2">
      <button
        id="emailAlertCancel"
        class="px-3 py-1.5 text-xs font-semibold text-gray-600 hover:text-gray-800"
      >
        Cancel
      </button>
      <button
        id="emailAlertSave"
        class="px-3 py-1.5 text-xs font-semibold text-white bg-[#A1824C]
               hover:bg-[#8b6f3f] rounded-lg"
      >
        Subscribe
      </button>
    </div>
  </div>
</div>
<% } %> <!-- end if hasAnyProperty -->


<%- include('../components/footer') %>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Safely embed server data as JSON
    const allProperties = {
      flats: <%- JSON.stringify(flats || []) %>,
      plots: <%- JSON.stringify(plots || []) %>,
      agri:  <%- JSON.stringify(agri  || []) %>
    };

    const locationFilter   = document.getElementById('locationFilter');
    const priceFilter      = document.getElementById('priceFilter');
    const clearFiltersBtn  = document.getElementById('clearFilters');
    const resultsCount     = document.getElementById('resultsCount');
    const countNum         = document.getElementById('countNum');
    const loadingSpinner   = document.getElementById('loadingSpinner');

    // Build unique locations
    const locationsSet = new Set();
    Object.values(allProperties).forEach(function (list) {
      list.forEach(function (p) {
        if (p && p.location) locationsSet.add(p.location);
      });
    });

    Array.from(locationsSet).sort().forEach(function (loc) {
      if (!locationFilter) return;
      const option = document.createElement('option');
      option.value = loc;
      option.textContent = loc;
      locationFilter.appendChild(option);
    });

    function applyFilters() {
      if (!locationFilter || !priceFilter) return;

      const selectedLocation   = locationFilter.value.toLowerCase().trim();
      const selectedPriceRange = priceFilter.value;

      if (loadingSpinner) loadingSpinner.classList.remove('hidden');
      if (resultsCount)   resultsCount.classList.add('hidden');

      setTimeout(function () {
        let totalVisible = 0;
        const cards = document.querySelectorAll('.property-card');

        cards.forEach(function (card) {
          const cardLocation = (card.dataset.location || '').toLowerCase();
          const cardPrice    = parseInt(card.dataset.price || '0', 10);

          let matchesLocation = !selectedLocation ||
                                cardLocation.includes(selectedLocation) ||
                                selectedLocation.includes(cardLocation);

          let matchesPrice = true;
          if (selectedPriceRange) {
            const parts   = selectedPriceRange.split('-');
            const min     = parseInt(parts[0], 10);
            const maxPart = parts[1];
            const max     = maxPart === '+' || !maxPart ? Infinity : parseInt(maxPart, 10);
            matchesPrice  = cardPrice >= min && cardPrice <= max;
          }

          if (matchesLocation && matchesPrice) {
            card.style.display = 'flex';
            card.classList.remove('animate-fadeInUp');
            void card.offsetWidth;
            card.classList.add('animate-fadeInUp');
            totalVisible++;
          } else {
            card.style.display = 'none';
          }
        });

        if (totalVisible > 0 && resultsCount && countNum) {
          countNum.textContent = totalVisible.toString();
          resultsCount.classList.remove('hidden');
        }

        if (loadingSpinner) loadingSpinner.classList.add('hidden');
      }, 250);
    }

    if (locationFilter) locationFilter.addEventListener('change', applyFilters);
    if (priceFilter)    priceFilter.addEventListener('change', applyFilters);

    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', function () {
        if (locationFilter) locationFilter.value = '';
        if (priceFilter)    priceFilter.value = '';
        document.querySelectorAll('.property-card').forEach(function (card) {
          card.style.display = 'flex';
        });
        if (resultsCount) resultsCount.classList.add('hidden');
      });
    }

    applyFilters();

    // Email alert subscription
    const emailAlertBtn    = document.getElementById('emailAlertBtn');
    const emailAlertModal  = document.getElementById('emailAlertModal');
    const emailAlertInput  = document.getElementById('emailAlertInput');
    const emailAlertSave   = document.getElementById('emailAlertSave');
    const emailAlertCancel = document.getElementById('emailAlertCancel');

    function openEmailModal() {
      if (!emailAlertModal) return;
      emailAlertModal.classList.remove('hidden');
      emailAlertModal.classList.add('flex');
      if (emailAlertInput) emailAlertInput.focus();
    }

    function closeEmailModal() {
      if (!emailAlertModal) return;
      emailAlertModal.classList.add('hidden');
      emailAlertModal.classList.remove('flex');
      if (emailAlertInput) emailAlertInput.value = '';
    }

    if (emailAlertBtn) {
      emailAlertBtn.addEventListener('click', openEmailModal);
    }

    if (emailAlertCancel) {
      emailAlertCancel.addEventListener('click', closeEmailModal);
    }

    if (emailAlertModal) {
      emailAlertModal.addEventListener('click', function (e) {
        if (e.target === emailAlertModal) closeEmailModal();
      });
    }

    if (emailAlertSave) {
      emailAlertSave.addEventListener('click', async function () {
        const email = (emailAlertInput?.value || '').trim();
        if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
          alert('Please enter a valid email address.');
          return;
        }

        try {
          const res = await fetch('/alerts/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          if (res.ok) {
            alert('Email alerts enabled successfully.');
            closeEmailModal();
          } else {
            const data = await res.json().catch(() => ({}));
            alert(data.message || 'Something went wrong. Please try again.');
          }
        } catch (err) {
          alert('Network error. Please try again.');
        }
      });
    }

    // Share buttons (Web Share API + WhatsApp fallback)
    function initShareButtons() {
      const shareButtons = document.querySelectorAll('.share-btn');

      shareButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          const title    = btn.dataset.title || 'Property in Uttarakhand';
          const location = btn.dataset.location || '';
          const price    = btn.dataset.price || '';
          const url      = window.location.href.split('#')[0];

          const shareText =
            `${title} - ${location}\nPrice: ₹${Number(price).toLocaleString('en-IN')}\n\nCheck this property: ${url}`;

          if (navigator.share) { // Web Share API supported [web:2]
            navigator
              .share({
                title: title,
                text: shareText,
                url: url
              })
              .catch(function () {
                const waUrl = 'https://wa.me/?text=' + encodeURIComponent(shareText); // [web:8][web:10]
                window.open(waUrl, '_blank');
              });
          } else {
            const waUrl = 'https://wa.me/?text=' + encodeURIComponent(shareText); // [web:8][web:10]
            window.open(waUrl, '_blank');
          }
        });
      });
    }

    initShareButtons();
  });
</script>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideInDown {
    from { opacity: 0; transform: translateY(-30px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeInUp { animation: fadeInUp 0.6s ease-out forwards; }
  .animate-slideInDown { animation: slideInDown 0.6s ease-out forwards; }
  .animation-delay-200 { animation-delay: 0.2s; }
  .animation-delay-300 { animation-delay: 0.3s; }
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
