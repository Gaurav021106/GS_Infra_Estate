<!doctype html>
<html lang="en">
<head>
  <% 
    // Safe variable access
    const prop = (typeof property !== 'undefined' ? property : (typeof p !== 'undefined' ? p : {}));
    const images = prop.imageUrls || [];
    const videos = prop.videoUrls || [];
    const pageTitleSafe = typeof pageTitle !== 'undefined' ? pageTitle : (prop.title || 'GS Infra & Estate');
    const metaDescriptionSafe = typeof metaDescription !== 'undefined' ? metaDescription : (prop.description || 'Residential, commercial, industrial & agricultural properties in Dehradun, Rishikesh & Haridwar.');
  %>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KKDNYYE9YY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-KKDNYYE9YY');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/jpeg" href="/images/logo.jpg" />

  <title><%= pageTitleSafe %></title>
  <meta name="description" content="<%= metaDescriptionSafe %>" />
  <meta name="keywords" content="real estate Dehradun, real estate Rishikesh, property, buy property, plots, houses" />
  <meta name="author" content="GS Infra & Estate" />
  
  <link rel="canonical" href="https://www.gsinfraandestate.com/property/<%= prop.slug || prop._id || '' %>" />

  <meta property="og:title" content="<%= pageTitleSafe %>" />
  <meta property="og:description" content="<%= metaDescriptionSafe %>" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://www.gsinfraandestate.com/property/<%= prop.slug || prop._id || '' %>" />
  <% if (images.length) { %>
    <meta property="og:image" content="<%= images[0] %>" />
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link href="https://fonts.cdnfonts.com/css/instrument-serif" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Italiana&display=swap" rel="stylesheet">

  <style>
    :root { --global-transition-duration: 300ms; }
    .heading { font-family: 'Italiana', serif; }
    html { scroll-behavior: smooth; }
    body { -webkit-font-smoothing: antialiased; }
    
    a, button, img { transition: all var(--global-transition-duration) cubic-bezier(0.4, 0, 0.2, 1); }
    
    .reveal { opacity: 0; transform: translateY(20px); transition: opacity 0.8s, transform 0.8s; }
    .reveal.active { opacity: 1; transform: translateY(0); }

    /* Custom Spinner */
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Facade Styles (Click-to-Load) */
    .facade-container {
        position: relative; width: 100%; height: 100%; cursor: pointer; overflow: hidden;
        background-color: #f3f4f6;
    }
    .facade-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.2);
        display: flex; align-items: center; justify-content: center;
        transition: background 0.3s;
    }
    .facade-container:hover .facade-overlay { background: rgba(0,0,0,0.4); }
    
    /* Fullscreen fixes */
    #model-viewer-container:fullscreen { background: white; width: 100vw; height: 100vh; display: flex; }
    #model-viewer-container:fullscreen model-viewer { width: 100%; height: 100%; }
  </style>
  
  </head>

<body class="bg-gray-50 text-gray-900">
  <%
    const priceText = typeof prop.price === 'number' ? prop.price.toLocaleString('en-IN') : (prop.price || '');
    const suitable = (prop.suitableFor || []).join(', ');
  %>

  <main class="min-h-screen">
    <div class="bg-gradient-to-b from-gray-50 via-white to-gray-50">
      
      <section class="relative mx-auto max-w-6xl px-4 pt-6 pb-8 lg:pt-8 lg:pb-10">
          <nav class="mb-4 flex items-center justify-between text-[11px] text-gray-500">
            <div class="flex items-center gap-1">
              <a href="/" class="hover:text-indigo-600 underline">Home</a>
              <span>/</span>
              <span><%= prop.city || 'Location' %></span>
            </div>
            <div class="flex items-center gap-2 rounded-full bg-white px-2 py-1 shadow-sm border border-gray-100">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
              <span class="uppercase tracking-widest text-[10px] text-emerald-600 font-medium">Verified</span>
            </div>
          </nav>

          <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
            <div class="max-w-2xl">
              <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight text-gray-900 leading-tight">
                <%= prop.title || 'Property details' %>
              </h1>
              <p class="mt-2 text-sm text-gray-600 flex flex-wrap items-center gap-2">
                 üìç <%= prop.location || '' %>, <%= prop.city || '' %>, <%= prop.state || 'Uttarakhand' %>
              </p>
            </div>

            <div class="flex flex-col gap-3 rounded-2xl bg-white/80 p-4 border border-gray-200 shadow-sm">
              <div>
                <p class="text-[10px] uppercase tracking-widest text-gray-500 font-semibold">Asking price</p>
                <p class="text-2xl font-bold text-emerald-600">
                  <%= priceText ? '‚Çπ ' + priceText : 'Contact for price' %>
                </p>
              </div>
              <div class="flex gap-2">
                 <a href="tel:<%= prop.contactPhone || '+918279702969' %>" class="flex-1 bg-indigo-600 text-white px-4 py-2.5 rounded-full text-xs font-semibold text-center hover:bg-indigo-700 shadow-sm">
                   Call now
                 </a>
                 <button id="whatsapp-visit-btn" class="border border-gray-300 bg-white px-4 py-2.5 rounded-full text-xs font-semibold hover:bg-emerald-50 hover:text-emerald-600">
                   üí¨ WhatsApp
                 </button>
              </div>
            </div>
          </div>
          
          <div class="mt-5 flex flex-wrap gap-3 text-xs">
             <button id="share-button" class="flex items-center gap-2 rounded-full border border-gray-200 bg-white px-4 py-1.5 hover:shadow-sm">
               Share Property
             </button>
             <span id="share-status" class="text-emerald-600 hidden font-medium">Link copied!</span>
          </div>
      </section>

      <section class="relative mx-auto max-w-6xl px-4 pb-10">
        <div class="grid gap-8 lg:grid-cols-[1.6fr_1fr]">
          <div class="space-y-6">
            
            <div class="group relative overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm" data-main-image>
              <% if (images.length) { %>
                <img src="<%= images[0] %>" alt="<%= prop.title %>" class="h-72 w-full object-cover sm:h-80 lg:h-96 group-hover:scale-105 transition duration-700" loading="eager" fetchpriority="high" />
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 pointer-events-none">
                   <span class="bg-black/50 text-white px-4 py-2 rounded-full text-xs backdrop-blur-sm">View Gallery</span>
                </div>
              <% } else { %>
                 <div class="flex h-72 w-full items-center justify-center text-gray-500 bg-gray-50">No image</div>
              <% } %>
              
              <div class="absolute left-4 top-4 flex gap-2 pointer-events-none">
                <% if (prop.category) { %> <span class="bg-white/90 backdrop-blur px-3 py-1 rounded-full text-[10px] font-bold"><%= prop.category %></span> <% } %>
                <% if (prop.status) { %> <span class="bg-emerald-500/90 text-white px-3 py-1 rounded-full text-[10px] font-bold"><%= prop.status %></span> <% } %>
              </div>
            </div>

            <% if (images.length > 1) { %>
              <div class="reveal grid grid-cols-4 gap-3">
                <% images.slice(1).forEach(function(img, idx) { %>
                  <button class="relative rounded-xl overflow-hidden border border-gray-200 h-20 sm:h-24 group" data-thumb data-index="<%= idx + 1 %>">
                    <img src="<%= img %>" class="w-full h-full object-cover group-hover:scale-110 transition" loading="lazy" />
                  </button>
                <% }); %>
              </div>
            <% } %>

            <% if (prop.virtualTourUrl) { %>
              <section class="reveal rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                <h2 class="text-sm font-bold uppercase tracking-wider text-gray-900 mb-3">Virtual tour</h2>
                <div class="aspect-video w-full rounded-xl overflow-hidden bg-gray-100 relative shadow-inner" id="tour-container">
                    <div class="facade-container group" onclick="loadVirtualTour(this, '<%= prop.virtualTourUrl %>')">
                        <img src="<%= images[0] || '/images/logo.jpg' %>" class="w-full h-full object-cover opacity-90 transition group-hover:scale-105 duration-700" alt="Tour Preview">
                        
                        <div class="facade-overlay">
                            <button class="bg-white/95 text-gray-900 px-6 py-3 rounded-full font-bold shadow-xl flex items-center gap-3 hover:scale-105 transition transform">
                                <span class="flex items-center justify-center w-8 h-8 bg-indigo-600 rounded-full text-white pl-0.5">‚ñ∂</span> 
                                <span>Start Virtual Tour</span>
                            </button>
                        </div>
                        
                        <div class="absolute bottom-4 right-4 bg-black/60 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md">
                          Click to Load
                        </div>
                    </div>
                </div>
              </section>
            <% } %>

            <% if (prop.map3dUrl) { %>
            <section class="reveal rounded-2xl border border-gray-200 bg-white p-5 shadow-sm group">
              <div class="flex items-center justify-between mb-3">
                 <h2 class="text-sm font-bold uppercase tracking-wider text-gray-900">3D View</h2>
                 <span class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded border border-indigo-100">Interactive</span>
              </div>
              
              <div class="aspect-video w-full rounded-xl overflow-hidden border border-gray-100 bg-gray-50 relative" id="model-viewer-container">
                 
                 <div id="model-facade" class="facade-container group" onclick="init3DModel('<%= prop.map3dUrl %>', '<%= images[0] || '' %>')">
                    <img src="<%= images[0] || '/images/logo.jpg' %>" class="w-full h-full object-cover transition group-hover:scale-105 duration-700" alt="3D Preview">
                    <div class="facade-overlay flex-col gap-3">
                        <div class="w-16 h-16 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30 shadow-xl group-hover:scale-110 transition duration-500">
                             <span class="text-3xl filter drop-shadow-md">üßä</span>
                        </div>
                        <button class="bg-white text-indigo-600 px-6 py-2 rounded-full font-bold shadow-lg text-sm hover:bg-indigo-50 transition">
                            Tap to Load 3D View
                        </button>
                    </div>
                 </div>

                 <div id="model-wrapper" class="w-full h-full hidden animate-fadeIn"></div>
                 
                 <button id="enter-fullscreen" class="hidden absolute top-4 left-4 z-10 bg-white/90 p-2 rounded-full shadow hover:text-indigo-600 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                 </button>
              </div>
              
              <div class="mt-3 flex gap-4 text-xs text-gray-500">
                <span>üñ±Ô∏è Drag to rotate</span> <span>üîç Scroll to zoom</span>
              </div>
            </section>
            <% } %>
          </div>

          <aside class="space-y-4">
             <% if (prop.description) { %>
               <section class="reveal rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                 <h2 class="text-sm font-bold uppercase tracking-wider mb-3">Overview</h2>
                 <div class="text-sm text-gray-700 whitespace-pre-line leading-relaxed"><%= prop.description %></div>
               </section>
             <% } %>

             <% if (prop.features && prop.features.length) { %>
               <section class="reveal rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
                 <h2 class="text-sm font-bold uppercase tracking-wider mb-4">Features</h2>
                 <ul class="grid gap-2 text-sm text-gray-700 sm:grid-cols-2">
                   <% prop.features.forEach(feat => { %>
                     <li class="flex items-start gap-2"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-indigo-500"></span><%= feat %></li>
                   <% }); %>
                 </ul>
               </section>
             <% } %>

             <section class="reveal rounded-2xl bg-gradient-to-br from-indigo-50 to-white p-6 border border-indigo-100 shadow-sm">
                <h3 class="font-semibold text-gray-900 mb-2">Talk to our expert</h3>
                <p class="text-sm text-gray-600 mb-5">Get guidance for this property in <%= prop.city %>.</p>
                <a href="tel:<%= prop.contactPhone || '+918279702969' %>" class="flex w-full items-center justify-center gap-2 rounded-xl bg-gray-900 px-4 py-3 text-sm font-semibold text-white hover:bg-gray-800 transition shadow-lg shadow-gray-200">
                  Call Expert Now
                </a>
             </section>
          </aside>
        </div>
      </section>
    </div>
  </main>

  <div id="imageLightbox" class="fixed inset-0 z-50 hidden bg-black/95 flex items-center justify-center touch-none backdrop-blur-sm">
    <button id="closeLightbox" class="absolute top-4 right-4 text-white p-2 hover:scale-110 transition">‚úï</button>
    <img id="lightboxImage" class="max-h-[90vh] max-w-[95vw] object-contain shadow-2xl" />
    <button id="prevBtn" class="hidden md:block absolute left-4 text-white text-4xl hover:scale-110 transition">‚Äπ</button>
    <button id="nextBtn" class="hidden md:block absolute right-4 text-white text-4xl hover:scale-110 transition">‚Ä∫</button>
  </div>

  <%- include('../components/footer') %>

  <script>
    // 1. SCROLL REVEAL
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => { if(e.isIntersecting) { e.target.classList.add('active'); obs.unobserve(e.target); } });
    });
    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

    // =========================================================
    // 2. VIRTUAL TOUR LOADER (SMART SWITCHER)
    // =========================================================
    window.loadVirtualTour = function(el, url) {
        const container = el.parentElement;
        
        // Add Loading Spinner
        container.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-indigo-600"><div class="loader"></div></div>`;
        
        // Detect if it is a Video File (MP4/WebM) or an external link (YouTube/Matterport)
        // Checks for file extensions OR if it comes from our /uploads/ folder
        const isVideoFile = url.match(/\.(mp4|webm|ogg)$/i) || url.includes('/uploads/');

        if (isVideoFile) {
            // Use native <video> tag for performance
            const video = document.createElement('video');
            video.src = url;
            video.className = "w-full h-full object-cover animate-fadeIn";
            video.controls = true;
            video.autoplay = true;
            video.playsInline = true; // Important for mobile
            
            video.onloadeddata = () => { container.innerHTML = ''; container.appendChild(video); };
            video.onerror = () => { container.innerHTML = '<div class="text-sm text-red-500 p-4">Video failed to load</div>'; };
            
        } else {
            // Use <iframe> for external links (YouTube, etc)
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.className = "w-full h-full border-0 animate-fadeIn";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen";
            iframe.onload = () => { container.innerHTML = ''; container.appendChild(iframe); };
        }
    };

    // =========================================================
    // 3. 3D MODEL LOADER (LAZY LOAD)
    // =========================================================
    window.init3DModel = function(modelUrl, posterUrl) {
        const facade = document.getElementById('model-facade');
        const wrapper = document.getElementById('model-wrapper');
        const fsBtn = document.getElementById('enter-fullscreen');
        
        // Show loading state
        facade.innerHTML = '<div class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 text-gray-500 gap-3"><div class="loader"></div><span class="text-xs font-medium">Loading 3D Engine...</span></div>';

        // Dynamically load the heavy model-viewer script only now
        if (!customElements.get('model-viewer')) {
            const script = document.createElement('script');
            script.type = 'module';
            script.src = "https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js";
            script.onload = () => injectModelViewer(modelUrl, posterUrl);
            document.head.appendChild(script);
        } else {
            injectModelViewer(modelUrl, posterUrl);
        }

        function injectModelViewer(src, poster) {
            facade.style.display = 'none';
            wrapper.classList.remove('hidden');
            fsBtn.classList.remove('hidden');

            wrapper.innerHTML = `
              <model-viewer 
                src="${src}" 
                poster="${poster}" 
                camera-controls auto-rotate ar 
                shadow-intensity="1" 
                loading="eager"
                style="width: 100%; height: 100%;"
              ></model-viewer>
            `;
            
            // Re-bind fullscreen logic to the new element
            const viewer = wrapper.querySelector('model-viewer');
            const container = document.getElementById('model-viewer-container');
            
            fsBtn.onclick = () => {
                if (!document.fullscreenElement) container.requestFullscreen();
                else document.exitFullscreen();
            };
        }
    };

    // 4. SHARE & WHATSAPP
    document.getElementById('share-button')?.addEventListener('click', () => {
        if(navigator.share) navigator.share({ title: document.title, url: window.location.href });
        else { navigator.clipboard.writeText(window.location.href); document.getElementById('share-status').classList.remove('hidden'); }
    });

    const waBtn = document.getElementById('whatsapp-visit-btn');
    if(waBtn) {
        waBtn.addEventListener('click', () => {
            const text = encodeURIComponent(`Hello, I am interested in: ${document.title}\nLink: ${window.location.href}`);
            window.open(`https://wa.me/<%= (prop.contactPhone || '918279702969').replace(/\D/g,'') %>?text=${text}`, '_blank');
        });
    }

    // 5. LIGHTBOX
    const lb = document.getElementById('imageLightbox');
    const lbImg = document.getElementById('lightboxImage');
    const imgs = [ "<%= images[0] || '' %>", <% images.slice(1).forEach(url => { %> "<%= url %>", <% }); %> ].filter(Boolean);
    let curIdx = 0;

    function openLb(i) { curIdx = i; lbImg.src = imgs[i]; lb.classList.remove('hidden'); }
    document.querySelector('[data-main-image]')?.addEventListener('click', () => openLb(0));
    document.querySelectorAll('[data-thumb]').forEach(b => b.addEventListener('click', () => openLb(+b.dataset.index)));
    
    document.getElementById('closeLightbox').onclick = () => lb.classList.add('hidden');
    document.getElementById('nextBtn').onclick = () => { curIdx = (curIdx+1)%imgs.length; lbImg.src = imgs[curIdx]; };
    document.getElementById('prevBtn').onclick = () => { curIdx = (curIdx-1+imgs.length)%imgs.length; lbImg.src = imgs[curIdx]; };
  </script>
</body>
</html>