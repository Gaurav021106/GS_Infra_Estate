<%- include('../components/header') %>

<% const hasAnyProperty =
  (flats && flats.length) ||
  (plots && plots.length) ||
  (agri && agri.length); %>

<% if (hasAnyProperty) { %>
<section
  class="flex flex-col items-center justify-center mt-4 p-6 bg-gray-50 rounded-xl shadow-sm w-full animate-fadeInUp animation-delay-200"
>
  <!-- Top: Heading + Filters -->
  <div class="w-full mb-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="mb-1 text-3xl font-bold animate-slideInDown">Available Properties</h1>
        <a href="/" class="text-blue-600 hover:underline">Back to Home</a>
        <p class="text-sm text-gray-500">
          Filter properties by location and budget across Uttarakhand.
        </p>
        <p id="resultsCount" class="mt-1 text-xs text-gray-600 font-medium hidden">
          Showing <span id="countNum">0</span> properties
        </p>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full md:w-auto bg-white/70 p-3 rounded-xl shadow-sm">
        <!-- Location Filter -->
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Location</label>
          <select
            id="locationFilter"
            class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C] text-xs md:text-sm transition-all duration-200"
          >
            <option value="">All Locations</option>
          </select>
        </div>

        <!-- Price Range Filter -->
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1">Price Range</label>
          <select
            id="priceFilter"
            class="w-full p-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C] text-xs md:text-sm transition-all duration-200"
          >
            <option value="">All Prices</option>
            <option value="100000-500000">₹1L - ₹5L</option>
            <option value="500000-10000000">₹5L - ₹1Cr</option>
            <option value="10000000+">₹1Cr+</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="flex items-end">
          <button
            id="clearFilters"
            type="button"
            class="w-full px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs md:text-sm font-semibold rounded-lg shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-0.5"
          >
            Clear Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Email Alerts Button -->
    <div class="mt-3">
      <button
        id="emailAlertBtn"
        type="button"
        class="px-4 py-2.5 bg-[#A1824C] hover:bg-[#8b6f3f]
               text-white text-xs md:text-sm font-semibold rounded-lg
               shadow-sm hover:shadow-md transition-all duration-200 hover:-translate-y-0.5"
      >
        Enable Email Alerts
      </button>
      <p class="mt-1 text-[11px] text-gray-500">
        Get an email whenever a new property is listed in any location.
      </p>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div
    id="loadingSpinner"
    class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 hidden items-center justify-center"
  >
    <div class="bg-white p-6 rounded-2xl shadow-2xl animate-pulse">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#A1824C] mx-auto mb-3"></div>
      <p class="text-sm md:text-lg font-semibold text-gray-800">Filtering properties...</p>
    </div>
  </div>

  <!-- Flats & Houses -->
  <% if (flats && flats.length) { %>
    <div class="w-full mb-6" data-section="flats">
      <h2 class="text-xl font-semibold mb-3">Flats &amp; Houses in Uttarakhand</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6" id="flatsContainer">
        <% flats.forEach(p => { %>
          <%- include('../components/property-card', { p, type: 'flat' }) %>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Plots -->
  <% if (plots && plots.length) { %>
    <div class="w-full mb-6" data-section="plots">
      <h2 class="text-xl font-semibold mb-3">Plots in Uttarakhand</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6" id="plotsContainer">
        <% plots.forEach(p => { %>
          <%- include('../components/property-card', { p, type: 'plot' }) %>
        <% }) %>
      </div>
    </div>
  <% } %>

  <!-- Agricultural Land -->
  <% if (agri && agri.length) { %>
    <div class="w-full" data-section="agri">
      <h2 class="text-xl font-semibold mb-3">Agricultural Land in Uttarakhand</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6" id="agriContainer">
        <% agri.forEach(p => { %>
          <%- include('../components/property-card', { p, type: 'agri' }) %>
        <% }) %>
      </div>
    </div>
  <% } %>
</section>

<!-- Email Alert Modal -->
<div
  id="emailAlertModal"
  class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center"
>
  <div class="bg-white rounded-xl p-5 w-80 shadow-2xl">
    <h3 class="text-lg font-semibold mb-2">Get New Property Alerts</h3>
    <p class="text-xs text-gray-500 mb-3">
      Get an email whenever a new property is listed in any location.
    </p>
    <input
      type="email"
      id="emailAlertInput"
      placeholder="Enter your email"
      class="w-full mb-3 px-3 py-2 border border-gray-200 rounded-lg
             text-sm focus:ring-2 focus:ring-[#A1824C] focus:border-[#A1824C]"
    />
    <div class="flex justify-end gap-2">
      <button
        id="emailAlertCancel"
        class="px-3 py-1.5 text-xs font-semibold text-gray-600 hover:text-gray-800"
      >
        Cancel
      </button>
      <button
        id="emailAlertSave"
        class="px-3 py-1.5 text-xs font-semibold text-white bg-[#A1824C]
               hover:bg-[#8b6f3f] rounded-lg"
      >
        Subscribe
      </button>
    </div>
  </div>
</div>
<% } %>

<!-- Global Image Lightbox -->
<div
  id="imageLightbox"
  class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center"
>
  <button
    id="lightboxClose"
    class="absolute top-4 right-4 text-white text-2xl font-bold px-3 py-1 bg-black/40 rounded-full hover:bg-black/70"
  >
    ✕
  </button>
  <div class="max-w-4xl w-[94%] max-h-[90vh] flex flex-col items-center">
    <img
      id="lightboxImage"
      src=""
      alt="Property image"
      class="w-full h-auto max-h-[80vh] object-contain rounded-xl shadow-2xl bg-black"
    />
    <p id="lightboxCaption" class="mt-3 text-sm text-gray-200 text-center line-clamp-2"></p>
  </div>
</div>

<%- include('../components/footer') %>

<link rel="stylesheet" href="/css/property-listing.css">
<script>
  window.flats = <%- JSON.stringify(flats || []) %>;
  window.plots = <%- JSON.stringify(plots || []) %>;
  window.agri  = <%- JSON.stringify(agri  || []) %>;
</script>
<script src="/js/property-listing.js" defer></script>
<script src="/js/share-buttons.js" defer></script>
<script src="/js/image-lightbox.js" defer></script>
